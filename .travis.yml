dist: trusty
sudo: required
language: cpp
matrix:
    include:
        - os: osx
        - os: linux
          addons:
              apt:
                  sources:
                      - ubuntu-toolchain-r-test
                      - sourceline: 'ppa:maarten-fonville/protobuf'
                  packages:
                      - gcc-7
                      - g++-7
                      - cmake-data
                      - cmake
                      - libopencv-dev
                      - libprotobuf-dev
                      - protobuf-compiler
              coverity_scan:
                  project:
                      name: "pfnet-research/menoh"
                      description: "Menoh: DNN inference library"
                  notification_email: menoh-oss@preferred.jp
                  build_command_prepend: cov-configure --compiler /usr/bin/g++-7 --comptype g++ -- -march=native -fPIC -std=gnu++14 && cmake -DMKLDNN_INCLUDE_DIR="$HOME/mkl-dnn/include" -DMKLDNN_LIBRARY="$HOME/mkl-dnn/lib/libmkldnn.so" .
                  build_command: make
                  branch_pattern: coverity_scan
env:
    global:
        # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
        #   via the "travis encrypt" command using the project repo's public key
        - secure: "q1I4YsB5VcNaF9Unmm6T92ht9/KwOGbxZVCpXIp5XUVulpaZq7sTd3rL1v3r1mUCYaabkcy9N4UPQjJZsuOlU4jc8zPzPxPir7hOER5umlkfSMuc1RhmShT8cK9naznqv7FLSTIjTZIao85Lrgxgw0B6xzcWc0kSeJPJVAmS5kwmC/FCQS2MPQpyhfE5JjpUrePOT+lRTB6Psm5bWyEww8bPsatO2k5b8DDdmUJIxmuJ1UTCx5rj/ZcTJLWAsj8D7u9aUfCmOhV5+hqHBvJd/06FLt254SNmvzmVLW9CVU/aZvuTtRECgBYCVndR7NxWpRHo1SBKqgLu+cNOFoFyt++1V+FAbpxj9JMktZNyxWp22c/FvBBdHynOsxBxVFdGIzhcwhQMiHFLOK3pnyiByabtINhERqrszkbpztOepBE3o8PGpjOz8iIx1TtLgmWwAw5D6WXx8FeP5FMkJwpXckCMI5tX5wPoU8cpZIwPjCxG3Z+ojHw+80pQWCrMZnEDfcf9zskJNsmv/GbiWGEvI8xVG0gst5VmjaAXK7JhC0cKvPOEmCFRGY+BWdjD3dkYIIElUmBRfTRDpcDJV6j5r1xMv7QKRFDfAjnC33KLJo2aALZTrkRPveIP2h2jU13ZbemN8GKWwEWNzidmwtCbH4rpe80rFqASWkyfii7HrEI="
cache:
    directories:
        - $HOME/mkl-dnn
before_install:
    - |
      if [ "$TRAVIS_OS_NAME" = "linux" ]; then
        echo -n | openssl s_client -connect scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-
      fi
install:
    - |
      if [ "$TRAVIS_OS_NAME" = "osx" ]; then
        brew update
        brew upgrade python
        export PATH=/usr/local/opt/python/libexec/bin:$PATH
        brew install numpy || true
        brew install opencv mkl-dnn protobuf
      else
        pyenv local 3.6
      fi
    - if [ "$TRAVIS_OS_NAME" = "linux" -a "$CXX" = "g++" ]; then export CXX="g++-7" CC="gcc-7"; fi
    - if [ "$TRAVIS_OS_NAME" = "linux" ]; then sh .travis/install_mkldnn.sh; fi
    - mkdir -p data
    - pip install --user chainer
    - python retrieve_data.py
    - python gen_test_data.py
before_script:
    - |
      echo 'Checking tools and libraries version:'
      if [ "$TRAVIS_OS_NAME" = "linux" ]; then
        apt list --installed
        ldconfig -p
      fi
      if [ "$TRAVIS_OS_NAME" = "osx" ]; then
        brew list --versions
      fi
      cmake --version
      make --version
    - ls -R $HOME/mkl-dnn
script:
    #- if [ -f cov-int/build-log.txt ]; then cat cov-int/build-log.txt; fi
    # CMakeCache.txt generated for coverity_scan build hinders out-of-source build
    - if [ -f CMakeCache.txt ]; then rm CMakeCache.txt; fi
    - mkdir build
    - cd build
    - |
      if [ "$TRAVIS_OS_NAME" == "osx" ]; then
        cmake -DENABLE_TEST=ON \
        ..
      else
        cmake -DENABLE_TEST=ON \
        -DMKLDNN_INCLUDE_DIR="$HOME/mkl-dnn/include" \
        -DMKLDNN_LIBRARY="$HOME/mkl-dnn/lib/libmkldnn.so" \
        ..
      fi
    - make
    - ./test/menoh_test
deploy:
    - provider: releases
      api_key:
          secure: "Ji7bCcKD6J5ptB6uaiBRGZc7SvNX+TJs+ODm5YnF1Q9lkbv+0J14g8RednSC6IdEef7ENYmDICw4slasOc+6hHT8f+lDtMhCgNeFLNuLTAxgRQ8PMhHzVwC2J9msQH5tKAzH3o9RXcNXkjjEbL6RgsbBWilktZkpqpL6SxVawG3qa4WkwI4QvzvAf6p6tpBWmzoTazdEb5WjOMihMr4Bnkb9XNT+S10X3Y1VRoOA5E7c1v08Y+IM+otn++d4IaVlAEP8EMCNpHnS+344jTcKOQeMg2cJNc84XRo0h0s5/u8YRtWVCWtwA0iQP1dCZQW9f/p17YLSIPybIQCqydJ5A9Az4PIkT+f0FcX08v3DJtLARbQCACw5ytIz3InDfW8OiHjPbQp1hvB+yk+odSYohSkuuaug/mwEK+Fji8YmN0KM5Xp7TEbGDoZYLtOt/Ndk6BwKBDhpIe9Uhw0NVfruZ4v/wE+MOaz6O4JNOojEk9rAYR5VIz9hClh+bBRVGSVb/wDwLp8WMBmKMJFlK47bFXTBRvWMMoOEoHzYwtNWgaNU10Y7nllCE8cHzCl+s1sUotQhqDNvzblrclBOXrSF3uP0NcmBAGUDdAfcXhcpEtCvL8qud7MkIHh8rjh0qhG9hRJelr4kfsM/dPxLcE+ZFGi8znSnxvqpLLh3oNTKzIA="
      file: /home/travis/build/pfnet-research/menoh/build/menoh/libmenoh.so
      skip_cleanup: true
      on:
          tags: true
          condition: $TRAVIS_OS_NAME = linux
    - provider: releases
      api_key:
          secure: "Ji7bCcKD6J5ptB6uaiBRGZc7SvNX+TJs+ODm5YnF1Q9lkbv+0J14g8RednSC6IdEef7ENYmDICw4slasOc+6hHT8f+lDtMhCgNeFLNuLTAxgRQ8PMhHzVwC2J9msQH5tKAzH3o9RXcNXkjjEbL6RgsbBWilktZkpqpL6SxVawG3qa4WkwI4QvzvAf6p6tpBWmzoTazdEb5WjOMihMr4Bnkb9XNT+S10X3Y1VRoOA5E7c1v08Y+IM+otn++d4IaVlAEP8EMCNpHnS+344jTcKOQeMg2cJNc84XRo0h0s5/u8YRtWVCWtwA0iQP1dCZQW9f/p17YLSIPybIQCqydJ5A9Az4PIkT+f0FcX08v3DJtLARbQCACw5ytIz3InDfW8OiHjPbQp1hvB+yk+odSYohSkuuaug/mwEK+Fji8YmN0KM5Xp7TEbGDoZYLtOt/Ndk6BwKBDhpIe9Uhw0NVfruZ4v/wE+MOaz6O4JNOojEk9rAYR5VIz9hClh+bBRVGSVb/wDwLp8WMBmKMJFlK47bFXTBRvWMMoOEoHzYwtNWgaNU10Y7nllCE8cHzCl+s1sUotQhqDNvzblrclBOXrSF3uP0NcmBAGUDdAfcXhcpEtCvL8qud7MkIHh8rjh0qhG9hRJelr4kfsM/dPxLcE+ZFGi8znSnxvqpLLh3oNTKzIA="
      file: /Users/travis/build/pfnet-research/menoh/build/menoh/libmenoh.dylib
      skip_cleanup: true
      on:
          tags: true
          condition: $TRAVIS_OS_NAME = osx
